# 📋 SensoryAI 后端交互基础设施完善计划

**制定日期**: 2026年1月22日  
**更新日期**: 2026年1月22日  
**项目状态**: ✅ 功能1已完成 → 进行功能2实时字幕

---

## 一、当前基础设施现状分析

### ✅ 已有的基础设施

#### 1. **网络层基础**
- **Retrofit HTTP 客户端** (`RetrofitClient.java`)
  - ✅ 已配置 OkHttp (超时30s、日志拦截)
  - ✅ 已定义 `ApiService` 接口 (用于图片上传)
  - ⚠️ 需要: 调整后端地址、完善上传流程

- **WebSocket 实时通信** (`WebSocketManager.java`)
  - ✅ 已实现连接、重连、心跳机制
  - ✅ 已定义消息实体类 (SubtitleMessage、AgentProgressMessage 等)
  - ✅ 已支持 PCM16 音频流发送
  - ⚠️ 需要: 完善消息路由、UI绑定

#### 2. **音频采集基础**
- **AudioRecorder** (`audio/AudioRecorder.java`)
  - ✅ 已配置 16kHz 单声道 PCM16 (符合协议)
  - ✅ 已支持后台线程采集
  - ✅ 已支持本地文件保存(调试用)
  - ⚠️ 需要: 与WebSocket集成、回调完善

#### 3. **识别处理基础**
- **RecognizeProcessor** (`process/processor/RecognizeProcessor.java`)
  - ✅ MediaPipe 手势识别初始化
  - ✅ 食指指尖坐标提取 (TipX, TipY)
  - ✅ 悬停算法(1秒触发)
  - ✅ 震动反馈
  - ⚠️ 需要: HTTP请求集成、图片采集

#### 4. **渲染层基础**
- **RenderData 数据模型**
  - ✅ 已包含指尖坐标、悬停进度、触发状态
  - ✅ 已包含麦克风按钮状态
  
- **RenderProcessor** 
  - ✅ 已绘制光标准星、进度条
  - ✅ 已处理双目镜像(左右屏)
  - ⚠️ 需要: 与卡片显示协调

#### 5. **UI 框架基础**
- **MainActivity** (`MainActivity.java`)
  - ✅ 已集成 `BaseMirrorActivity` (支持双目合目)
  - ✅ 已创建 AR卡片布局
  - ✅ 已实现卡片位置跟随
  - ⚠️ 需要: 与网络响应绑定

#### 6. **权限和初始化**
- ✅ 摄像头权限框架
- ✅ 麦克风权限框架
- ✅ 处理器初始化顺序

---

## 二、两个核心功能的完善需求

### ✅ 功能 1: 药品识别 (HTTP + 拍照 + 卡片) - **已完成**

**流程**: 悬停3秒 → 拍照 → 发送HTTP请求 → 接收药品信息 → 在卡片显示

**✅ 已完成内容**:
1. ✅ **拍照集成**: 悬停触发和硬件按键触发都已集成拍照
2. ✅ **HTTP请求**: SendRemoteProcessor 完整实现 PNG 上传
3. ✅ **响应处理**: 后端返回结果实时显示在 AR 卡片
4. ✅ **错误处理**: 网络异常、超时、错误提示
5. ✅ **防误触**: 悬停时间3秒 + 冷却时间8秒

**实现细节**:
- 创建 `performPhotoCapture()` 通用方法
- PNG 无损保存到本地相册
- 完整高清图(1920x1080) HTTP 上传
- 卡片显示识别结果，张手关闭

---

### 🔵 功能 2: 实时字幕 (WebSocket + 流式音频 + 字幕显示)

**流程**: 触发麦克风 → 连接WebSocket → 实时发送PCM16音频 → 接收实时文本 → 在字幕条显示

**当前缺口**:
1. ❌ **音频采集集成**: AudioRecorder 采集的数据没有流向 WebSocketManager
2. ❌ **流式传输**: WebSocket 的 onMessage 已处理，但没有实时更新UI
3. ❌ **字幕UI**: `SubtitleStreamView` 已存在但没有与消息源绑定
4. ❌ **会话管理**: session_id 生成逻辑需要与麦克风按钮关联

**需要实现的模块**:
- `AudioStreamProcessor` (新建): 连接 AudioRecorder → WebSocketManager，处理音频流
- 修改 `WebSocketManager.handleMessage()`: 完善字幕消息路由
- 修改 `MainActivity.initWebSocketListener()`: 完善字幕消息处理回调

---

## 三、系统架构现状图

```
┌─────────────────────────────────────────────────────────┐
│                    MainActivity (UI层)                    │
│  - AR卡片显示 (tvCardTitle/tvCardContent)                │
│  - 字幕条显示 (SubtitleStreamView)                       │
│  - 双目合目处理 (mBindingPair)                           │
└────────────────┬────────────────────┬────────────────────┘
                 │                    │
        ┌────────▼─────────┐ ┌───────▼────────┐
        │ 识别流程          │ │ 字幕流程        │
        ├──────────────────┤ ├────────────────┤
        │ RecognizeProc    │ │ AudioRecorder  │
        │ (手势→指尖坐标)  │ │ (音频采集)     │
        │ (悬停→触发)      │ │                │
        │ [❌缺]拍照      │ │ [❌缺]→WS流   │
        │ [❌缺]→HTTP    │ │                │
        └────────┬────────┘ └───────┬────────┘
                 │                  │
        ┌────────▼────────┐ ┌──────▼───────┐
        │ Retrofit HTTP   │ │ WebSocket    │
        │ [❌缺]响应处理 │ │ [△部分]消息路由
        │ ApiService      │ │ 实体类已定义
        └────────┬────────┘ └──────┬───────┘
                 │                 │
        ┌────────▼─────────────────▼────────┐
        │        后端 API 服务               │
        ├─────────────────────────────────────┤
        │ POST /api/recognize (药品识别)      │
        │ WS /ws/chat (实时字幕/智能体)      │
        └─────────────────────────────────────┘
```

---

## 四、完善计划 (具体任务清单)

### **阶段 1: 准备基础设施** (优先级: ⭐⭐⭐⭐⭐)

#### Task 1.1: 创建 HTTP 图片上传管理器
- **文件**: 新建 `network/ImageUploadManager.java`
- **职责**:
  - 调用 ICameraManager 获取高清图片
  - 将 Bitmap 转换为 MultipartBody.Part
  - 调用 Retrofit API 上传
  - 处理 ResponseBody 解析(返回药品JSON)
  - 错误重试机制 (最多3次)
  - 超时处理 (15s)
- **关键接口**:
  ```java
  void uploadImage(Bitmap bitmap, ImageUploadCallback callback)
  
  interface ImageUploadCallback {
      void onSuccess(MedicineInfo info);
      void onError(String message);
  }
  ```

#### Task 1.2: 创建响应处理器
- **文件**: 新建 `entity/MedicineInfo.java`
- **职责**: 定义药品信息POJO (名称、用法、剂量等)
- 示例:
  ```java
  {
    "name": "阿莫西林",
    "usage": "口服，每次500mg",
    "dosage": "3次/天",
    "warnings": "不可与某些药物混用"
  }
  ```

#### Task 1.3: 创建音频流处理器
- **文件**: 新建 `network/AudioStreamProcessor.java`
- **职责**:
  - 监听 AudioRecorder 的音频输出
  - 实时转发给 WebSocketManager (PCM16 字节流)
  - 处理异常断线
  - 支持暂停/恢复
- **关键接口**:
  ```java
  void startStreaming()
  void stopStreaming()
  void pauseStreaming()
  void resumeStreaming()
  ```

---

### **阶段 2: 集成识别流程** (优先级: ⭐⭐⭐⭐) - **✅ 已完成**

#### ✅ Task 2.1: 修改 RecognizeProcessor.process()
- ✅ 当 isTriggered=true 时，自动拍照+上传
- ✅ 防抖: 8秒冷却时间

#### ✅ Task 2.2: 修改 MainActivity 的识别响应处理
- ✅ 监听识别事件，显示卡片
- ✅ 显示药品信息 (tvCardTitle, tvCardContent)
- ✅ 卡片位置跟随指尖
- ✅ 异常处理: 网络错误时显示提示

#### ✅ Task 2.3: 完善卡片清屏逻辑
- ✅ 支持"张开手掌"关闭
- ✅ 悬停3秒触发，防止误触

---

### **阶段 3: 集成字幕流程** (优先级: ⭐⭐⭐⭐) - **🔵 进行中**

#### Task 3.1: 完善 WebSocketManager 消息处理
- **文件**: `WebSocketManager.java` 的 `handleMessage()`
- **步骤**:
  1. 增强消息类型判断 (subtitle | agent_progress | agent_result | error)
  2. 对于 subtitle 消息:
     - 提取 `text` 和 `is_partial` 字段
     - 调用 `listener.onSubtitleUpdate(text, !is_partial)`
  3. 对于 error 消息:
     - 提取错误信息
     - 调用 `listener.onError(stage, message)`
- **JSON示例**:
  ```json
  {
    "type": "subtitle",
    "text": "早上好",
    "is_partial": true,
    "timestamp": 1234567890
  }
  ```

#### Task 3.2: 修改 MainActivity 的字幕监听
- **文件**: `MainActivity.java` 的 `initWebSocketListener()`
- **步骤**:
  1. 在 WebSocketManager 的 MessageListener 中处理字幕
  2. 当收到字幕时，调用 `runOnUiThread()` 更新 SubtitleStreamView
  3. 处理部分结果 vs 最终结果:
     - is_partial=true: 绿色字体，表示识别中
     - is_partial=false: 白色字体，表示确认
  4. 自动换行处理 (防止超长)
  5. 添加超时清屏 (60秒无新字幕则清空)

#### Task 3.3: 修改 AudioRecorder 的回调
- **文件**: `AudioRecorder.java`
- **步骤**:
  1. 当读取到音频数据时，立即转发给 AudioStreamProcessor
  2. 支持暂停/恢复
  3. 记录音频统计信息 (字节数、采集时间)
- **关键改进**: 当前代码有本地保存，需要添加流式转发选项

#### Task 3.4: 完善 WebSocket 连接管理
- **文件**: `WebSocketManager.java`
- **步骤**:
  1. 当麦克风触发时自动连接
  2. 当麦克风关闭时发送结束信号 `{"type": "final", "session_id": "xxx"}`
  3. 异常断线时自动重连 (最多5次，指数退避)
  4. 心跳保活 (已有，但需验证)

---

### **阶段 4: 调试和优化** (优先级: ⭐⭐⭐)

#### Task 4.1: 配置后端地址
- **文件**: `RetrofitClient.java` 和 `WebSocketManager.java`
- **步骤**:
  1. 与后端团队确认地址 (公网 IP、域名 或 内网穿透工具)
  2. 更新 `BASE_URL` 和 `WS_URL`
  3. 对于 HTTPS/WSS: 配置证书信任

#### Task 4.2: 日志和调试
- **创建文件**: 新建 `utils/DebugLogger.java`
- **职责**:
  - 统一管理所有网络请求日志
  - 记录请求/响应的完整流程
  - 保存日志到本地文件(便于离线分析)
- **关键信息**:
  - HTTP: URL、Method、Headers、Body、Response Status、Response Body
  - WebSocket: 连接状态、发送数据大小、接收消息类型

#### Task 4.3: 错误恢复和重试
- **实现**:
  - HTTP 图片上传: 网络异常时自动重试(3次，指数退避)
  - WebSocket: 断线自动重连(5次，3秒间隔)
  - 音频采集: 捕获异常，提示用户

#### Task 4.4: 性能优化
- **优化点**:
  - 图片压缩: 拍照后上传前压缩为 1920x1440 左右，减少传输时间
  - 音频缓冲: 调整缓冲大小，平衡延迟 vs 稳定性
  - 卡片渲染: 使用硬件加速，防止卡顿

---

## 五、技术细节补充

### 📌 协议规范 (后端定义)

#### 1. **图片识别请求**
```
POST /api/recognize HTTP/1.1
Content-Type: multipart/form-data

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="image"; filename="photo.jpg"
Content-Type: image/jpeg

[JPEG 二进制数据]
------WebKitFormBoundary7MA4YWxkTrZu0gW--
```

**响应**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "name": "阿莫西林",
    "usage": "口服，每次500mg，3次/天",
    "warnings": "避免与某些抗生素混用"
  }
}
```

#### 2. **音频流传输 (WebSocket)**

**连接建立**:
```
ws://[服务器]/ws/chat
```

**发送音频数据**:
```
[PCM16 字节流，每帧 3200 字节左右]
```

**接收字幕消息**:
```json
{
  "type": "subtitle",
  "text": "识别到的文字",
  "is_partial": true,
  "timestamp": 1234567890
}
```

**传输结束**:
```json
{
  "type": "final",
  "session_id": "xxx-uuid"
}
```

---

## 六、实施顺序建议

```
阶段 1: 基础设施搭建 (3-4天)
  ├─ Task 1.1: ImageUploadManager ✓
  ├─ Task 1.2: MedicineInfo 实体 ✓
  ├─ Task 1.3: AudioStreamProcessor ✓
  └─ 测试: Mock 后端响应

阶段 2: 识别流程集成 (2-3天)
  ├─ Task 2.1: RecognizeProcessor 拍照集成 ✓
  ├─ Task 2.2: MainActivity 卡片显示 ✓
  ├─ Task 2.3: 卡片清屏优化 ✓
  └─ 测试: 实际拍照 + HTTP 上传

阶段 3: 字幕流程集成 (2-3天)
  ├─ Task 3.1: WebSocket 消息路由 ✓
  ├─ Task 3.2: MainActivity 字幕显示 ✓
  ├─ Task 3.3: AudioRecorder 流式输出 ✓
  ├─ Task 3.4: WebSocket 连接管理 ✓
  └─ 测试: 实时录音 + 字幕显示

阶段 4: 调试优化 (2-3天)
  ├─ Task 4.1: 后端地址配置 ✓
  ├─ Task 4.2: 日志系统 ✓
  ├─ Task 4.3: 错误恢复 ✓
  ├─ Task 4.4: 性能优化 ✓
  └─ 测试: 完整流程测试

总计: 9-13 天
```

---

## 七、关键风险点

| 风险 | 影响 | 缓解方案 |
|------|------|--------|
| 后端 API 地址未确认 | 网络测试无法进行 | 尽早与后端团队同步，确认地址和协议 |
| 图片上传超时 | 用户体验差 | 设置合理超时(15s)，添加进度提示 |
| WebSocket 频繁断线 | 字幕卡顿 | 实现自动重连、心跳保活 |
| 音频延迟过高 | 不同步感 | 优化缓冲大小，监控端到端延迟 |
| 双目字幕显示不同步 | 双目合目破裂 | 使用 BindingPair 统一管理 |
| 权限请求失败 | 功能无法运行 | 提前告知用户，提供权限申请引导 |

---

## 八、测试清单

### ✅ 功能 1: 药品识别
- [x] 悬停3秒触发拍照 ✅
- [x] 拍照后 HTTP 请求成功发送 ✅
- [x] 后端返回药品信息并在卡片显示 ✅
- [x] 网络异常时显示错误提示 ✅
- [x] 8秒冷却时间防止重复触发 ✅
- [x] 张开手掌卡片消失 ✅

### 🔵 功能 2: 实时字幕 (下一项)
- [ ] 点击麦克风按钮连接 WebSocket
- [ ] 开始说话，WebSocket 接收到音频
- [ ] 实时字幕在屏幕底部显示
- [ ] 部分结果显示为绿色，最终结果显示为白色
- [ ] WebSocket 断线自动重连
- [ ] 点击麦克风关闭，发送结束信号
- [ ] 双目都能同时显示字幕

---

## 九、实施进度总结

### ✅ 已完成 (2026年1月22日)

**功能 1: 药品识别 HTTP 上传**
- ✅ 创建 `performPhotoCapture()` 通用方法
- ✅ 集成悬停触发 (3秒悬停)
- ✅ 集成硬件按键触发
- ✅ PNG 无损保存到本地相册
- ✅ HTTP 上传完整高清图 (1920x1080)
- ✅ AR 卡片显示识别结果
- ✅ 网络错误处理和提示
- ✅ 8秒冷却时间防误触
- ✅ 张手关闭卡片功能

**修改文件**:
- `MainActivity.java` - 新增 performPhotoCapture() 方法，修改悬停触发逻辑
- `RecognizeProcessor.java` - 修改 HOVER_DURATION 为 3000ms
- 编译状态: ✅ BUILD SUCCESSFUL

### 🔵 下一步: 功能 2 实时字幕

**需要完成的任务**:
1. **AudioRecorder 集成 WebSocket**
   - 音频采集数据实时转发给 WebSocketManager
   - 处理流式传输逻辑

2. **WebSocketManager 消息路由**
   - 完善 handleMessage() 处理字幕消息
   - 区分 is_partial (部分结果 vs 最终结果)

3. **MainActivity 字幕显示**
   - initWebSocketListener() 绑定字幕更新
   - SubtitleStreamView 实时更新
   - 双目合目字幕显示

4. **会话管理**
   - 麦克风触发时连接 WebSocket
   - 关闭时发送结束信号
   - 自动重连机制验证

---

## 十、后续维护建议

1. **监控和告警**: 记录网络请求失败率，设置告警阈值
2. **版本迭代**: 预留接口扩展空间，便于后续功能增加
3. **文档维护**: 保持 API 文档与代码同步
4. **用户反馈**: 收集用户的网络体验反馈，持续优化

---

**计划文档完成** ✅  
接下来可以按照上述计划逐步实施。
